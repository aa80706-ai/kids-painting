<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>兒童塗鴉產生器</title>
    <!-- Use Tailwind CSS for modern, responsive styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Use a fun, playful font from Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Fredoka', sans-serif;
        }
        canvas {
            border: 1px solid #ccc;
        }
    </style>
</head>
<body class="bg-white p-4 min-h-screen flex flex-col items-center justify-center">

    <div class="container max-w-4xl w-full mx-auto p-6 bg-white rounded-3xl shadow-lg border-4 border-gray-300">
        <h1 class="text-4xl font-bold text-center text-gray-800 mb-2">兒童塗鴉產生器</h1>
        <p class="text-center text-gray-600 mb-6">將彩色圖片變成有趣的塗鴉線稿！</p>

        <!-- Message/Error Box -->
        <div id="message-box" class="hidden mb-4 p-3 rounded-lg text-center font-medium transition-all duration-300"></div>

        <div class="flex flex-col md:flex-row items-center justify-center space-y-4 md:space-y-0 md:space-x-4 mb-6">
            <label class="block">
                <span class="sr-only">選擇檔案</span>
                <input type="file" id="file-input" accept="image/*" class="block w-full text-sm text-pink-700
                    file:mr-4 file:py-2 file:px-4
                    file:rounded-full file:border-0
                    file:text-sm file:font-semibold
                    file:bg-pink-200 file:text-pink-700
                    hover:file:bg-pink-300
                "/>
            </label>
            <button id="convert-btn" class="w-full md:w-auto px-8 py-3 text-white font-semibold rounded-full shadow-lg transition-all duration-300
                bg-green-500 hover:bg-green-600 disabled:bg-gray-400 transform hover:scale-105">
                轉換
            </button>
        </div>
        
        <!-- Sliders for adjustment -->
        <div id="controls" class="flex flex-col md:flex-row flex-wrap items-center justify-center space-y-4 md:space-y-0 md:space-x-4 mb-6">
            <div class="flex items-center space-x-2 w-full md:w-auto">
                <label for="contrast-slider" class="text-gray-700 font-medium whitespace-nowrap">對比度: <span id="contrast-value">100</span>%</label>
                <input type="range" id="contrast-slider" min="0" max="200" value="100" class="w-full md:w-48 accent-green-500">
            </div>
            <div class="flex items-center space-x-2 w-full md:w-auto">
                <label for="blur-slider" class="text-gray-700 font-medium whitespace-nowrap">模糊半徑: <span id="blur-value">2</span>px</label>
                <input type="range" id="blur-slider" min="0" max="20" value="2" class="w-full md:w-48 accent-green-500">
            </div>
            <div class="flex items-center space-x-2 w-full md:w-auto">
                <label for="darkness-slider" class="text-gray-700 font-medium whitespace-nowrap">線條深度: <span id="darkness-value">100</span>%</label>
                <input type="range" id="darkness-slider" min="0" max="200" value="100" class="w-full md:w-48 accent-green-500">
            </div>
            <div class="flex items-center space-x-2 w-full md:w-auto">
                <label for="threshold-slider" class="text-gray-700 font-medium whitespace-nowrap">線稿閾值: <span id="threshold-value">200</span></label>
                <input type="range" id="threshold-slider" min="0" max="255" value="200" class="w-full md:w-48 accent-green-500">
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-start">
            <!-- Original Image Section -->
            <div class="flex flex-col items-center">
                <h2 class="text-xl font-semibold text-gray-700 mb-2">原彩色圖片</h2>
                <img id="original-img" alt="Original Image" class="w-full h-auto rounded-lg shadow-md max-w-full object-contain" />
            </div>

            <!-- Result Canvas Section -->
            <div class="flex flex-col items-center">
                <h2 class="text-xl font-semibold text-gray-700 mb-2">塗鴉線稿</h2>
                <canvas id="result-canvas" class="w-full h-auto rounded-lg shadow-md"></canvas>
                <a id="download-link" href="#" download="line-drawing.png" class="hidden mt-4">
                    <button id="download-btn" class="w-full md:w-auto px-8 py-3 bg-pink-500 text-white font-semibold rounded-full shadow-lg transition-all duration-300 hover:bg-pink-600 transform hover:scale-105">
                        下載塗鴉
                    </button>
                </a>
            </div>
        </div>
    </div>

    <script>
        // DOM element references
        const fileInput = document.getElementById('file-input');
        const convertBtn = document.getElementById('convert-btn');
        const originalImg = document.getElementById('original-img');
        const resultCanvas = document.getElementById('result-canvas');
        const downloadLink = document.getElementById('download-link');
        const messageBox = document.getElementById('message-box');
        const contrastSlider = document.getElementById('contrast-slider');
        const contrastValueSpan = document.getElementById('contrast-value');
        const blurSlider = document.getElementById('blur-slider');
        const blurValueSpan = document.getElementById('blur-value');
        const darknessSlider = document.getElementById('darkness-slider');
        const darknessValueSpan = document.getElementById('darkness-value');
        const thresholdSlider = document.getElementById('threshold-slider');
        const thresholdValueSpan = document.getElementById('threshold-value');
        
        let lastLoadedBmp = null; // Store the last loaded ImageBitmap

        // Function to show a user-friendly message
        function showMessage(text, type = 'info') {
            messageBox.textContent = text;
            messageBox.className = 'mb-4 p-3 rounded-lg text-center font-medium transition-all duration-300';
            messageBox.classList.remove('hidden');
            if (type === 'success') {
                messageBox.classList.add('bg-green-100', 'text-green-700');
            } else if (type === 'error') {
                messageBox.classList.add('bg-red-100', 'text-red-700');
            } else {
                messageBox.classList.add('bg-blue-100', 'text-blue-700');
            }
        }

        // Apply filters to an image bitmap and return a new canvas
        function applyFilter(bmp, filters) {
            const canvas = document.createElement('canvas');
            canvas.width = bmp.width;
            canvas.height = bmp.height;
            const ctx = canvas.getContext('2d');
            ctx.filter = filters;
            ctx.drawImage(bmp, 0, 0);
            return canvas;
        }

        // Generate a line drawing from two canvases (one for blurred, inverted, and one for black and white)
        function generateLineDrawing(bnw, blur) {
            const canvas = document.createElement('canvas');
            canvas.width = bnw.width;
            canvas.height = bnw.height;
            const ctx = canvas.getContext('2d');
            
            // Draw the black and white image first
            ctx.drawImage(bnw, 0, 0, canvas.width, canvas.height);
            
            // Use the 'color-dodge' composite operation to blend the blurred and inverted image
            ctx.globalCompositeOperation = 'color-dodge';
            ctx.drawImage(blur, 0, 0, canvas.width, canvas.height);
            
            // Revert composite operation to default
            ctx.globalCompositeOperation = 'source-over';
            
            return canvas;
        }
        
        // Apply threshold filter to a canvas
        function applyThreshold(canvas, threshold) {
            const ctx = canvas.getContext('2d');
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;

            for (let i = 0; i < data.length; i += 4) {
                // Get the grayscale value (using luminance formula)
                const gray = (data[i] * 0.299) + (data[i + 1] * 0.587) + (data[i + 2] * 0.114);

                // Apply thresholding
                const color = gray > threshold ? 255 : 0;
                
                // Set the new pixel values to pure black or pure white
                data[i] = color;
                data[i + 1] = color;
                data[i + 2] = color;
            }
            ctx.putImageData(imageData, 0, 0);
        }

        // Main conversion logic, now in a separate function
        function performConversion() {
            if (!lastLoadedBmp) {
                return;
            }
            
            const contrast = contrastSlider.value;
            const blurRadius = blurSlider.value;
            const darkness = darknessSlider.value;
            const threshold = thresholdSlider.value;

            // Update display values
            contrastValueSpan.textContent = contrast;
            blurValueSpan.textContent = blurRadius;
            darknessValueSpan.textContent = darkness;
            thresholdValueSpan.textContent = threshold;

            try {
                // Create a black and white version of the image, with contrast
                const bnw = applyFilter(lastLoadedBmp, `grayscale(1) contrast(${contrast}%)`);
                
                // Create a blurred and inverted black and white version, with all filters applied.
                const blur = applyFilter(lastLoadedBmp, `grayscale(1) invert(1) blur(${blurRadius}px) contrast(${contrast}%) brightness(${darkness}%)`);
                
                // Combine the two canvases to get the final line drawing
                const lineDrawing = generateLineDrawing(bnw, blur);

                // Display the initial result on the canvas
                resultCanvas.width = lineDrawing.width;
                resultCanvas.height = lineDrawing.height;
                const resultCtx = resultCanvas.getContext('2d');
                resultCtx.drawImage(lineDrawing, 0, 0);

                // Apply the threshold filter to the result canvas
                applyThreshold(resultCanvas, threshold);
                
                // Make the download link visible and update its href
                downloadLink.href = resultCanvas.toDataURL('image/png');
                downloadLink.classList.remove('hidden');

            } catch (error) {
                console.error('Conversion failed:', error);
                showMessage('圖片轉換失敗，請確認檔案格式正確。', 'error');
            }
        }

        // Event listener for the main "轉換" button
        convertBtn.addEventListener('click', async () => {
            const file = fileInput.files[0];
            if (!file) {
                showMessage('請先上傳圖片！', 'error');
                return;
            }

            showMessage('轉換中...', 'info');
            convertBtn.disabled = true;

            const reader = new FileReader();
            reader.onload = async (e) => {
                originalImg.src = e.target.result;
                downloadLink.classList.add('hidden'); // Hide download button during conversion

                originalImg.onload = async () => {
                    try {
                        lastLoadedBmp = await createImageBitmap(originalImg);
                        performConversion(); // Perform the initial conversion
                        showMessage('轉換完成！', 'success');

                    } catch (error) {
                        console.error('Conversion failed:', error);
                        showMessage('圖片載入失敗，請檢查檔案是否損壞。', 'error');
                    } finally {
                        convertBtn.disabled = false;
                    }
                };

                // Handle image loading errors
                originalImg.onerror = () => {
                    showMessage('圖片載入失敗，請檢查檔案是否損壞。', 'error');
                    convertBtn.disabled = false;
                };
            };
            reader.readAsDataURL(file);
        });

        // Event listeners for the sliders to re-run the conversion
        contrastSlider.addEventListener('input', performConversion);
        blurSlider.addEventListener('input', performConversion);
        darknessSlider.addEventListener('input', performConversion);
        thresholdSlider.addEventListener('input', performConversion);
    </script>
</body>
</html>
